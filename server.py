"""
Bitcoinaverage Crypto Ticker And Historical Price MCP Server

ä½¿ç”¨ FastMCP çš„ from_openapi æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆ

Version: 1.0.0
Transport: stdio
"""
import os
import json
import httpx
from fastmcp import FastMCP

# æœåŠ¡å™¨ç‰ˆæœ¬å’Œé…ç½®
__version__ = "1.0.0"
__tag__ = "bitcoinaverage_crypto_ticker_and_historical_price/1.0.0"

# API é…ç½®
API_KEY = os.getenv("API_KEY", "")

# ä¼ è¾“åè®®é…ç½®
TRANSPORT = "stdio"


# OpenAPI è§„èŒƒ
OPENAPI_SPEC = """{\n  \"openapi\": \"3.0.0\",\n  \"info\": {\n    \"title\": \"Bitcoinaverage Crypto Ticker And Historical Price\",\n    \"version\": \"1.0.0\",\n    \"description\": \"RapidAPI: blockchain-data-ltd-blockchain-data-ltd-default/bitcoinaverage-crypto-ticker-and-historical-price\"\n  },\n  \"servers\": [\n    {\n      \"url\": \"https://bitcoinaverage-crypto-ticker-and-historical-price.p.rapidapi.com\"\n    }\n  ],\n  \"paths\": {\n    \"/exchanges/ticker/{exchange}\": {\n      \"get\": {\n        \"summary\": \"Crypto Exchange Ticker price\",\n        \"description\": \"Get the latest price data for specific cryptocurrency exchange.\",\n        \"operationId\": \"crypto_exchange_ticker_price\",\n        \"parameters\": [\n          {\n            \"name\": \"exchange\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"description\": \"Example value: bitstamp\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          }\n        ],\n        \"responses\": {\n          \"200\": {\n            \"description\": \"Successful response\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {}\n              }\n            }\n          }\n        }\n      }\n    },\n    \"/indices/{symbol_set}/history/{symbol}\": {\n      \"get\": {\n        \"summary\": \"Historical price data for period\",\n        \"description\": \"Returns history price for specific symbol for certain period. Works in parallel to the Ticker endpoint where both symbol set and market symbol need to be specified. This endpoint additionally accepts the period query parameter that specifies the resolution of the data. Period can be: minute, hour or day.\",\n        \"operationId\": \"historical_price_data_for_period\",\n        \"parameters\": [\n          {\n            \"name\": \"period\",\n            \"in\": \"query\",\n            \"required\": false,\n            \"description\": \"Example value: day\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          },\n          {\n            \"name\": \"symbol_set\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"description\": \"Example value: global\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          },\n          {\n            \"name\": \"symbol\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"description\": \"Example value: BTCUSD\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          }\n        ],\n        \"responses\": {\n          \"200\": {\n            \"description\": \"Successful response\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {}\n              }\n            }\n          }\n        }\n      }\n    },\n    \"/indices/{symbol_set}/ticker/{symbol}\": {\n      \"get\": {\n        \"summary\": \"Cryptocurrency Index Ticker price\",\n        \"description\": \"Get the latest Ticker price for thousands of cryptocurrencies. Our Ticker data includes the latest price, bid, ask, 24h volume, moving average and price changes.\",\n        \"operationId\": \"cryptocurrency_index_ticker_price\",\n        \"parameters\": [\n          {\n            \"name\": \"symbol_set\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"description\": \"Symbol set can be one of: global, local, crypto, tokens and light\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          },\n          {\n            \"name\": \"symbol\",\n            \"in\": \"query\",\n            \"required\": true,\n            \"description\": \"The shorthand symbol of the market you are requesting data for. A full list of supported symbols grouped by symbol set can be found here.\",\n            \"schema\": {\n              \"type\": \"string\",\n              \"default\": null,\n              \"enum\": null\n            }\n          }\n        ],\n        \"responses\": {\n          \"200\": {\n            \"description\": \"Successful response\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {}\n              }\n            }\n          }\n        }\n      }\n    },\n    \"/info/indices/ticker\": {\n      \"get\": {\n        \"summary\": \"List of all supported crypto markets\",\n        \"description\": \"Lists all supported cryptocurrency markets by the BitcoinAverage API. New cryptos or tokens are added on a monthly basis.\",\n        \"operationId\": \"list_of_all_supported_crypto_markets\",\n        \"parameters\": [],\n        \"responses\": {\n          \"200\": {\n            \"description\": \"Successful response\",\n            \"content\": {\n              \"application/json\": {\n                \"schema\": {}\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"components\": {\n    \"securitySchemes\": {\n      \"ApiAuth\": {\n        \"type\": \"apiKey\",\n        \"in\": \"header\",\n        \"name\": \"X-RapidAPI-Key\"\n      }\n    }\n  },\n  \"security\": [\n    {\n      \"ApiAuth\": []\n    }\n  ]\n}"""

# åˆ›å»º HTTP å®¢æˆ·ç«¯
# è®¾ç½®é»˜è®¤ headers
default_headers = {}


# RapidAPI å¿…éœ€çš„ headers
if API_KEY:
    default_headers["X-RapidAPI-Key"] = API_KEY
    default_headers["X-RapidAPI-Host"] = "bitcoinaverage-crypto-ticker-and-historical-price.p.rapidapi.com"
else:
    print("âš ï¸  è­¦å‘Š: æœªè®¾ç½® API_KEY ç¯å¢ƒå˜é‡")
    print("   RapidAPI éœ€è¦ API Key æ‰èƒ½æ­£å¸¸å·¥ä½œ")
    print("   è¯·è®¾ç½®: export API_KEY=ä½ çš„RapidAPI-Key")

# å¯¹äº POST/PUT/PATCH è¯·æ±‚ï¼Œè‡ªåŠ¨æ·»åŠ  Content-Type
default_headers["Content-Type"] = "application/json"




client = httpx.AsyncClient(
    base_url="https://bitcoinaverage-crypto-ticker-and-historical-price.p.rapidapi.com", 
    timeout=30.0
)


# ä» OpenAPI è§„èŒƒåˆ›å»º FastMCP æœåŠ¡å™¨
openapi_dict = json.loads(OPENAPI_SPEC)
mcp = FastMCP.from_openapi(
    openapi_spec=openapi_dict,
    client=client,
    name="bitcoinaverage_crypto_ticker_and_historical_price",
    version=__version__
)


# æ³¨å†Œè¯·æ±‚æ‹¦æˆªå™¨ï¼Œä¸ºæ‰€æœ‰è¯·æ±‚æ·»åŠ  RapidAPI headers
_original_request = client.request

async def _add_rapidapi_headers(method, url, **kwargs):
    """æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œæ·»åŠ å¿…éœ€çš„ RapidAPI headers"""
    # ç¡®ä¿ headers å­˜åœ¨
    if 'headers' not in kwargs:
        kwargs['headers'] = {}
    
    # æ·»åŠ  RapidAPI å¿…éœ€çš„ headers
    if API_KEY:
        kwargs['headers']['X-RapidAPI-Key'] = API_KEY
        kwargs['headers']['X-RapidAPI-Host'] = "bitcoinaverage-crypto-ticker-and-historical-price.p.rapidapi.com"
    else:
        print("âš ï¸  è­¦å‘Š: API_KEY æœªè®¾ç½®ï¼Œè¯·æ±‚å¯èƒ½å¤±è´¥")
    
    # å¯¹äº POST/PUT/PATCHï¼Œæ·»åŠ  Content-Type
    if method.upper() in ['POST', 'PUT', 'PATCH']:
        if 'Content-Type' not in kwargs['headers']:
            kwargs['headers']['Content-Type'] = 'application/json'
    
    return await _original_request(method, url, **kwargs)

# æ›¿æ¢ request æ–¹æ³•
client.request = _add_rapidapi_headers


def main():
    """ä¸»å…¥å£ç‚¹"""
    print(f"ğŸš€ å¯åŠ¨ Bitcoinaverage Crypto Ticker And Historical Price MCP æœåŠ¡å™¨")
    print(f"ğŸ“¦ ç‰ˆæœ¬: {__tag__}")
    print(f"ğŸ”§ ä¼ è¾“åè®®: {TRANSPORT}")
    
    print()
    
    # è¿è¡ŒæœåŠ¡å™¨
    
    mcp.run(transport="stdio")
    


if __name__ == "__main__":
    main()